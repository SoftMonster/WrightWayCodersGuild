<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChatGPT Client with Iframes</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f7f9fc;
      color: #333;
    }
    body {
      display: flex;
      flex-direction: column;
    }
    header {
      background: #4f46e5;
      color: white;
      padding: 1rem 2rem;
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
      box-shadow: 0 2px 4px rgb(0 0 0 / 0.1);
    }
    #apiKeyContainer, #apiKeyHelp {
      padding: 0 1rem;
      max-width: 720px;
      margin: 0.5rem auto;
    }
    #apiKeyContainer {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }
    #apiKey {
      flex: 1;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: 1.5px solid #d1d5db;
      border-radius: 8px;
    }
    label[for="apiKey"] {
      font-weight: 600;
      color: #374151;
      white-space: nowrap;
    }
    #apiKeyHelp {
      font-size: 0.9rem;
      color: #4f46e5;
      text-align: center;
    }
    #apiKeyHelp a {
      color: #4f46e5;
      text-decoration: underline;
    }
    #apiKeyHelp a:hover {
      color: #4338ca;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 720px;
      width: 100%;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 14px rgb(0 0 0 / 0.1);
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #e2e8f0;
      scroll-behavior: smooth;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    p.user {
      margin: 0;
      padding: 0.5rem 1rem;
      border-radius: 12px;
      background: #4f46e5;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 2px;
      max-width: 80%;
      line-height: 1.4;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    iframe.assistant-frame {
      border: none;
      width: 100%;
      min-height: 150px;
      border-radius: 8px;
      box-shadow: 0 0 0 1px #e5e7eb;
    }

    form {
      display: flex;
      padding: 1rem 1.5rem;
      background: #fafafa;
    }

    #userInput {
      flex: 1;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border: 1.5px solid #d1d5db;
      border-radius: 9999px;
    }

    #userInput:focus {
      border-color: #4f46e5;
      outline-offset: 2px;
    }

    button#sendBtn {
      margin-left: 1rem;
      background: #4f46e5;
      border: none;
      color: white;
      font-weight: 600;
      padding: 0 1.5rem;
      border-radius: 9999px;
      cursor: pointer;
    }

    button#sendBtn:hover:not(:disabled) {
      background: #4338ca;
    }

    button#sendBtn:disabled {
      background: #a5b4fc;
      cursor: not-allowed;
    }

    #chat::-webkit-scrollbar {
      width: 8px;
    }
    #chat::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<header>ChatGPT Client</header>

<div id="apiKeyContainer">
  <label for="apiKey">OpenAI API Key:</label>
  <input type="password" id="apiKey" placeholder="Enter your API key here" autocomplete="off" />
</div>
<div id="apiKeyHelp">
  Don't have an API key? Get one from <a href="https://platform.openai.com/account/api-keys" target="_blank" rel="noopener noreferrer">OpenAI API Keys</a>.
</div>

<main>
  <div id="chat" role="log" aria-live="polite" aria-relevant="additions"></div>

  <form id="chatForm" onsubmit="event.preventDefault(); sendMessage();">
    <input type="text" id="userInput" placeholder="Type your message..." required />
    <button type="submit" id="sendBtn">Send</button>
  </form>
</main>

<script>
  let messages = [];

  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, (m) => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    })[m]);
  }

  function encodeToIframe(content) {
    const html = `<html><body style="margin:0;padding:1rem;font-family:sans-serif;background:white;">${content}</body></html>`;
    return 'data:text/html;charset=utf-8,' + encodeURIComponent(html);
  }

  async function sendMessage() {
    const apiKey = document.getElementById("apiKey").value.trim();
    const input = document.getElementById("userInput");
    const chat = document.getElementById("chat");
    const userMessage = input.value.trim();
    if (!apiKey || !userMessage) return;

    messages.push({ role: "user", content: userMessage });
    chat.innerHTML += `<p class="user"><strong>You:</strong> ${escapeHtml(userMessage)}</p>`;
    input.value = "";
    input.disabled = true;

    if (!messages.find(m => m.role === "system")) {
      messages.unshift({
        role: "system",
        content: "Respond with HTML content to be embedded in an iframe. Do not explain anything. Do not use markdown. Use minimal inline styles for layout if needed."
      });
    }

    try {
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
          model: "gpt-4",
          messages: messages,
          temperature: 0.7,
        }),
      });

      const data = await response.json();
      const reply = data.choices?.[0]?.message?.content || "";
      messages.push({ role: "assistant", content: reply });

      const iframe = document.createElement("iframe");
      iframe.className = "assistant-frame";
      iframe.src = encodeToIframe(reply);
      chat.appendChild(iframe);
      chat.scrollTop = chat.scrollHeight;

    } catch (err) {
      chat.innerHTML += `<p class="user"><strong>Error:</strong> ${escapeHtml(err.message)}</p>`;
    } finally {
      input.disabled = false;
    }
  }
</script>

</body>
</html>
