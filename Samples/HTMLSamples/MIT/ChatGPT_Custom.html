<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChatGPT Client</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      overflow: hidden;
    }

    #layout {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #4f46e5;
      color: white;
      padding: 1rem;
      font-size: 1.5rem;
      text-align: center;
      font-weight: bold;
    }

    #apiControls {
      background: #ffffff;
      display: flex;
      align-items: center;
      padding: 0.5rem 1rem;
      gap: 0.5rem;
      border-bottom: 1px solid #ccc;
    }

    #apiControls input {
      flex: 1;
      padding: 0.5rem 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    #apiHelp {
      text-align: center;
      font-size: 0.9rem;
      background: #eef;
      padding: 0.5rem;
    }

    #apiHelp a {
      color: #4f46e5;
      text-decoration: underline;
    }

    #chat {
      flex: 1;
      overflow-y: scroll;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    p.user {
      margin: 0;
      padding: 0;
      color: #111827;
      align-self: flex-end;
      max-width: 100%;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .assistant-container {
      width: 1024px;
      height: 600px;
      flex-shrink: 0;
      overflow: hidden;
    }

    iframe.assistant-frame {
      width: 1024px;
      height: 600px;
      border: none;
    }

    footer {
      background: #ffffff;
      padding: 1rem;
      display: flex;
      gap: 1rem;
      border-top: 1px solid #ccc;
    }

    #userInput {
      flex: 1;
      padding: 0.75rem 1rem;
      border-radius: 9999px;
      border: 1px solid #ccc;
    }

    #sendBtn {
      padding: 0.75rem 1.5rem;
      border-radius: 9999px;
      background: #4f46e5;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    #sendBtn:disabled {
      background: #a5b4fc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="layout">
    <header>ChatGPT Client</header>

    <div id="apiControls">
      <label for="apiKey">API Key:</label>
      <input type="password" id="apiKey" placeholder="Enter your API key" autocomplete="off" />
    </div>

    <div id="apiHelp">
      Donâ€™t have an API key? <a href="https://platform.openai.com/account/api-keys" target="_blank">Get one here</a>.
    </div>

    <div id="chat"></div>

    <footer>
      <input type="text" id="userInput" placeholder="Type your message..." />
      <button id="sendBtn" onclick="sendMessage()">Send</button>
    </footer>
  </div>

  <script>
    let messages = [];

    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, (m) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
      })[m]);
    }

    function encodeToIframe(content) {
      const html = `
        <!DOCTYPE html>
        <html>
          <head>
            <meta charset="UTF-8" />
            <style>
              html, body {
                margin: 0;
                padding: 1rem;
                width: 1024px;
                height: 600px;
                font-family: sans-serif;
                overflow: hidden;
              }
            </style>
          </head>
          <body>${content}</body>
        </html>
      `;
      return "data:text/html;charset=utf-8," + encodeURIComponent(html);
    }

    async function sendMessage() {
      const apiKey = document.getElementById("apiKey").value.trim();
      const input = document.getElementById("userInput");
      const chat = document.getElementById("chat");
      const userMessage = input.value.trim();
      if (!apiKey || !userMessage) return;

      messages.push({ role: "user", content: userMessage });
      chat.innerHTML += `<p class="user">${escapeHtml(userMessage)}</p>`;
      input.value = "";
      input.disabled = true;

      if (!messages.find(m => m.role === "system")) {
        messages.unshift({
          role: "system",
          content: "Respond with HTML content to be embedded in an iframe. Do not explain anything outside the iframe content. Do not use markdown. Use inline styles. The HTML should be exactly 1024x600 with no scrollbars or blank space but resized to fit those dimensions beautifully, however resize fonts and controls rather than painting the space a block of color. Use emojis in your responses when helpful for the web design and make the web content beautiful, don't pad the lines too much, increase font size to fit. Make sure it all fits wonderfully within 1024x600. Make the content open in a new web page when double clicked."
        });
      }

      try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${apiKey}`,
          },
          body: JSON.stringify({
            model: "gpt-4",
            messages: messages,
            temperature: 0.7,
          }),
        });

        const data = await response.json();

        if (data.error) {
          // Display error message instead of iframe
          chat.innerHTML += `<p class="user"><strong>Error:</strong> ${escapeHtml(data.error.message)}</p>`;
        } else {
          const reply = data.choices?.[0]?.message?.content || "";
          messages.push({ role: "assistant", content: reply });

          const container = document.createElement("div");
          container.className = "assistant-container";

          const iframe = document.createElement("iframe");
          iframe.className = "assistant-frame";
          iframe.src = encodeToIframe(reply);

          container.appendChild(iframe);
          chat.appendChild(container);
          chat.scrollTop = chat.scrollHeight;
        }
      } catch (err) {
        chat.innerHTML += `<p class="user"><strong>Error:</strong> ${escapeHtml(err.message)}</p>`;
      } finally {
        input.disabled = false;
        input.focus();
      }
    }
  </script>
</body>
</html>
