<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChatGPT Client</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      overflow: hidden;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #4f46e5;
      color: white;
      padding: 1rem;
      font-size: 1.5rem;
      text-align: center;
      font-weight: bold;
      z-index: 1000;
    }

    #apiControls {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      background: #ffffff;
      display: flex;
      align-items: center;
      padding: 0.5rem 1rem;
      gap: 0.5rem;
      z-index: 1000;
      border-bottom: 1px solid #ccc;
    }

    #apiControls input {
      flex: 1;
      padding: 0.5rem 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    #apiHelp {
      position: fixed;
      top: 110px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 0.9rem;
      background: #eef;
      padding: 0.5rem;
      z-index: 1000;
    }

    #apiHelp a {
      color: #4f46e5;
      text-decoration: underline;
    }

    #chat {
      position: absolute;
      top: 150px;
      bottom: 70px;
      left: 0;
      right: 0;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    p.user {
      margin: 0;
      padding: 0;
      color: #111827;
      align-self: flex-end;
      max-width: 100%;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    iframe.assistant-frame {
      border: none;
      width: 100%;
      height: auto;
      max-height: 50vh;
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #ffffff;
      padding: 1rem;
      display: flex;
      gap: 1rem;
      border-top: 1px solid #ccc;
      z-index: 1000;
    }

    #userInput {
      flex: 1;
      padding: 0.75rem 1rem;
      border-radius: 9999px;
      border: 1px solid #ccc;
    }

    #sendBtn {
      padding: 0.75rem 1.5rem;
      border-radius: 9999px;
      background: #4f46e5;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    #sendBtn:disabled {
      background: #a5b4fc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

<header>ChatGPT Client</header>

<div id="apiControls">
  <label for="apiKey">API Key:</label>
  <input type="password" id="apiKey" placeholder="Enter your API key" autocomplete="off" />
</div>

<div id="apiHelp">
  Donâ€™t have an API key? <a href="https://platform.openai.com/account/api-keys" target="_blank">Get one here</a>.
</div>

<div id="chat"></div>

<footer>
  <input type="text" id="userInput" placeholder="Type your message..." />
  <button id="sendBtn" onclick="sendMessage()">Send</button>
</footer>

<script>
  let messages = [];

  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, (m) => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;',
    })[m]);
  }

  function encodeToIframe(content, iframeId) {
    const html = `
      <html>
        <head>
          <style>
            body {
              margin: 0;
              padding: 1rem;
              font-family: sans-serif;
            }
          </style>
          <script>
            function sendHeight() {
              const maxHeight = window.parent.innerHeight * 0.5;
              const height = Math.min(document.body.scrollHeight, maxHeight);
              parent.postMessage({ iframeId: "${iframeId}", height }, "*");
            }
            window.addEventListener("load", sendHeight);
            window.addEventListener("resize", sendHeight);
            setTimeout(sendHeight, 200);
          <\/script>
        </head>
        <body>${content}</body>
      </html>
    `;
    return "data:text/html;charset=utf-8," + encodeURIComponent(html);
  }

  window.addEventListener("message", (event) => {
    if (event.data?.iframeId && event.data?.height) {
      const iframe = document.getElementById(event.data.iframeId);
      if (iframe) {
        iframe.style.height = event.data.height + "px";
      }
    }
  });

  async function sendMessage() {
    const apiKey = document.getElementById("apiKey").value.trim();
    const input = document.getElementById("userInput");
    const chat = document.getElementById("chat");
    const userMessage = input.value.trim();
    if (!apiKey || !userMessage) return;

    messages.push({ role: "user", content: userMessage });
    chat.innerHTML += `<p class="user">${escapeHtml(userMessage)}</p>`;
    input.value = "";
    input.disabled = true;

    if (!messages.find(m => m.role === "system")) {
      messages.unshift({
        role: "system",
        content: "Respond with HTML content to be embedded in an iframe. Do not explain anything outside the iframe content. Do not use markdown. Use inline styles for layout and embed JavaScript into the iframe if needed. Aim to eliminate all blank space in your html. The html response should not be taller than a quarter of the screen height for a below average resolution. Do not pre-fix your response with ```html or end it with ```"
      });
    }

    try {
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
          model: "gpt-4",
          messages: messages,
          temperature: 0.7,
        }),
      });

      const data = await response.json();
      const reply = data.choices?.[0]?.message?.content || "";
      messages.push({ role: "assistant", content: reply });

      const iframeId = "iframe_" + Date.now();
      const iframe = document.createElement("iframe");
      iframe.id = iframeId;
      iframe.className = "assistant-frame";
      iframe.src = encodeToIframe(reply, iframeId);
      chat.appendChild(iframe);
      chat.scrollTop = chat.scrollHeight;

    } catch (err) {
      chat.innerHTML += `<p class="user"><strong>Error:</strong> ${escapeHtml(err.message)}</p>`;
    } finally {
      input.disabled = false;
      input.focus();
    }
  }
</script>

</body>
</html>
